# 自作カーを作ろう

![Crunch](../assets/build_hardware/Crunch.png)

## 手っ取り早いポイント

* Raspberry Pi から簡単に制御できること
* 車体が大きすぎないこと。大きすぎると重く危険（そして高価）になる
* 最低限の機材を載せられるよう、車体が小さすぎないこと
* モデルが意味を持つだけの電力と制御性能の最低要件を満たすこと
* 低速でも滑らかに制御できること

つまり、次のような条件を満たす必要があります。

* モーター用のスピードコントローラー（ESC）が標準的なRC 3ピン制御信号（RC PWM方式）を受け付けること
* ステアリング用サーボが標準的なRC 3ピン制御信号（RC PWM方式）を受け付けること
* ESC とステアリングサーボそれぞれに接続できる標準の100ミル（2.54 mm）ピンヘッダーを備えた受信機があること
* DIYRobocars レースに参加するなら、スケールが1/18〜1/8程度であること
* モーターはブラシモーターかセンサー付きブラシレスモーターを使用すること。センサーなしブラシレスモーターは低速域で荒すぎます。ブラシレスモーター付きの車を購入した場合、ほとんどがセンサーなしブラシレスなので、ESC とともに交換する必要があります。

他にも選択肢はあるかもしれません。詳細はこの文書の最後を参照してください。

多くの車両製作者は「一体型」のRCカーに目を向けがちです。
それらが安いのは、
多くの電子部品や機械部品を一つのパッケージに統合しており、
そのため Raspberry Pi から車を制御するための適切な信号を途中で取り出せず、
実際、そのような信号が一体型車には
まったく存在しないこともあります。

こちらは受信機とESCが一体となった例です。通常、これは避けるべきです。
![RX ESC example](../assets/ESC_RX.png)

さらに電子工作の知識も必要です。例えば、電源ラインと制御信号の違い、
マイクロ秒の長さ、
そしてボルト・アンペア・ワット・アワー・オームなどの単位がどう関係するかといった内容です。

## シャーシの製作

Donkeycar 以外にも多くの設計がありますが、特に注目すべきものを2つ紹介します。

### Chilicorn レール

これは Markku.ai が開発した柔軟なマウントシステムです。

* [markku.ai](http://markku.ai)
* [markku-ai github](https://github.com/markku-ai)

### sCAD ファイル

長年コミュニティに参加している Doug LaRue 氏は、sCAD で自分のシャーシを作るための詳細な設計を公開しています。自作したいが CAD に慣れていない場合は、ここから始めると良いでしょう。

* [Basic Donkeycar](https://www.thingiverse.com/thing:2781404)
* [1/28 scale car](https://www.thingiverse.com/thing:3428003)
* [inverted donkey car](https://www.thingiverse.com/thing:2774944)

## サーボの詳細

RC サーボは車の前輪の舵を取るために使われます。
このサーボの電源線には通常 4.8V〜6V（車種により異なる）が供給され、
信号線には PWM 制御信号が送られます。一般的に3本の線は
黒・赤・白、あるいは茶・赤・黄の組み合わせで、暗い色（黒/茶）が GND、
中央の赤が電源、明るい色（白/黄）が制御信号です。

制御信号は RC 用 PWM で、1秒間に60回パルスが送られます。
このパルス幅によってサーボの左右位置が決まります。
パルスが1500マイクロ秒のときサーボは中央になり、1000
マイクロ秒なら一方に全開、
2000マイクロ秒なら反対側に全開となります。
これはモーターのデューティ比や LED の明るさを制御する PWM とは
別物である点に注意してください。

サーボへの電源は、通常モーターの ESC に内蔵された BEC
（Battery Eliminator Circuit）から供給されます。

## ESC の詳細

ESC の役割は、1000〜2000マイクロ秒の RC PWM 信号を受け取り、
それに応じてモーターへの電力を制御し、
前後進で異なる出力で回転させることです。1500
マイクロ秒はモーターにとっての『停止』を意味します。

バッテリーは通常、制御信号より太い配線で ESC に直接接続されます。
モーターは制御信号よりはるかに大きな電流を流すためです。
ESC からモーターへも同様に太い電源線がつながります。
標準的な Donkey のモーターと ESC のピーク電流はおよそ12Aですが、
1/8 スケールの強力なブラシレスモーター搭載車では、
200A に達することもあります。

さらに ESC には、線形またはスイッチング方式の電圧コンバーターが内蔵され、
ステアリングサーボを動かすための電源を供給します。これは通常
4.8V〜6V 程度で、ESC 内蔵 BEC の多くは
1A 以上の電流を供給できません。そのためサーボと Raspberry Pi を
同時に BEC から給電することは通常できません。

## 受信機の詳細

「受信機が必要」と記載されたキットカーを購入した場合、受信機を別途買う必要はありません。
Raspberry Pi と PCA9685 ボードが受信機の役割を果たし、
車へ制御信号を出力します。ステアリングサーボ、モーター、ESC は備えるが
無線だけ付属していないキットカーを購入するのは、
適切な信号系を持った車を作る上で好都合です。
受信機が独立している RC カーなら、適切な PWM 信号を想定して設計されているためです。

もし受信機が付属している場合は、ステアリングサーボと ESC 用の3ピン端子が並んでいるか確認してください。
受信機によっては、
追加チャンネル用の3ピン端子が空いている場合や、
ホーンやライトなどの付属装置を制御している場合もあります。

学習用データを収集する際に RC 無線で車を操縦する改造方法もあります。
これにより、PlayStation コントローラーやスマートフォンよりも精密に車を操作できます。
ただしこの方法では、PCA9685 ボードを外部マイコンに置き換え、
さらに Donkey のソフトウェアを
そのマイコン用に変更する必要があります。

最後に、PWM 制御信号に加えて
制御内容をまとめたシリアルデータを出力できる受信機もあります。
その例が FS-i6B で、PWM 信号用に6チャンネル出力を持つほか、
115,200bps のシリアルデータとして10チャンネル分を出力可能です。
これを外部マイコンや、ブートローダの設定変更とソフトのカスタマイズを行った
Raspberry Pi で読み取ることもできます。

## バッテリー

Donkey にはニッケル水素電池（NiMH）が付属しており、
これはモーターを5〜10分ほど動かせる程度の容量しかありません。
この電池は6セル構成で容量は1100mAhです。
NiMH 電池の電圧は0.9〜1.35Vで、標準電圧は1.2Vなので、
5.4〜8.1V 程度の電圧が得られると考えられます。

NiMH 電池は重量と体積あたりのエネルギー密度が中程度です。
そのため Magnet 車の稼働時間や性能を向上させたい場合は、
リチウムポリマー電池（LiPo）にアップグレードするとよいでしょう。通常は2セル（2S）を選びます。
リチウム電池は1セルあたり3.2〜4.2Vなので、6.4〜8.4Vとなります。
また LiPo は一般に、瞬間的に出せる電流量も、
蓄えられる電力量（Ah）も大きいため、より長時間走行できるでしょう。

バッテリーが保持できる電気量（稼働時間）は
アンペア時（Ah）またはミリアンペア時（mAh）で表されます。
一方、走行中に瞬間的に供給できる電流量は単にアンペアで示されます。
さらにややこしいことに、このアンペア値を1時間あたりのエネルギー量で割った
倍率として表したものを「C」と呼ぶことが多いです。
例えば10C 2000mAh の LiPo なら20A を、
5C 1100mAh の NiMH なら5.5A を出せます。
バッテリーは瞬間的には公称 C 値以上を出せることもありますが、
発熱や内部抵抗の上昇が起こるため、
常用できるものではありません。

カスタムカーを作る際は、ESC とモーターが必要とする電圧を把握し、
それに合った電圧のバッテリーを必ず選びましょう。小型の RC カーなら手頃な NiMH か 2S LiPo が、
大型の RC カーなら 3S（11.1V）、4S（14.8V）、場合によっては 6S（22.2V）の LiPo が使われます。
これに合わせて ESC とモーターの組み合わせも揃える必要があります。

最後に、バッテリーに合った充電器を必ず入手してください。
LiPo を使用する場合は、バランス端子を備えた信頼性の高いリチウム充電器を用意しましょう。
LiPo を1セルあたり3.2V以下まで放電してはいけません。
完全に放電させると正常な電圧まで充電できなくなり、
無理に充電すれば電池が過熱し発火する可能性があります。
燃えるテスラの映像を見ればその危険さが分かります。
わずか10ドルを節約しようとして、放電し過ぎた LiPo を再充電しようとした結果、家が焼けた例もあります。
そんな事態を避けるため、バッテリーのバランス端子に接続するアラームを用意し、
電圧が下がりすぎたら警告音が鳴るようにして、
すぐに切り離して充電するようにしてください。

## 物理的な制約

おもちゃの車に自動運転用のバッテリーや電子装置を追加すると、
車が本来想定していたより重くなります。1/8スケール程度の大きさなら
大きな問題にはならないかもしれませんが、1/18スケール以下の小さな車では、
追加された重量や上部の重みで車の反応が鈍り、
自動運転モデルがステアリングを制御しにくくなる場合があります。
車体を制御しづらくなります。

標準の Magnet 以外の車を使用する場合は、最低でも
すべてのハードウェアをしっかり固定する方法を考える必要があります。
単に積み重ねて配線だけで固定しようとしても、実際に走行・旋回するものではうまくいきません。
適切な取り付けポイントを見つけ、
手持ちの車体の寸法を測って独自の「ベースプレート」を作る必要があるでしょう。
このベースプレートは、3Dプリントやレーザーカット、CNC加工、あるいは薄い合板に穴を開ける方法でも構いませんが、
シャーシにぴったり合わせることが重要なので、
急いだり手を抜いたりしないようにしてください。

Doug LaRue は Thingiverse で[コンフィギュレーター](https://www.thingiverse.com/thing:2781404)も公開しており、簡単にカスタム3Dプリントプレートを作成できます。

## その他の選択肢

もちろん、1/5 スケールのニトロドラッグスターを自動運転化することも可能です。
ただしその場合は、各種部品についてさらに理解を深め、必要な統合作業を自分で行わなければなりません。
ニトロカーの制御信号自体は同じなので難しくはないかもしれませんが、
Donkey Racing ミートアップが行われる屋内会場では燃料車が禁止されており、
電動車のみ許可されている点に注意してください。

また、安価な二輪シャーシに LM298 H ブリッジを用い、
直接 PWM で2輪を戦車式に操舵する自動運転車を作ることも可能です。
しかしこの場合、Donkey ソフトウェアを正しい操舵出力に合わせて改造し、
さらに H ブリッジを Raspberry Pi にどのように配線するか自分で決める必要があります。
PCA9685 ボードが出力する PWM 信号は RC 用であってモーター制御用ではないことを理解してください。
また、手ごろな価格の二輪駆動ロボットシャーシの多くはサイズや強度、
機械的な精度が足りず、
ドンキーカーとして適していない場合がほとんどです.
