# Kerasパーツ

これらのパーツは[Keras](https://keras.io/)の高水準APIで定義されたモデルをカプセル化します。TensorFlowバックエンドで使用することを想定しています。このパーツはカメラ映像からステアリングとスロットルを再現するために、学習済みのニューラルネットワークを使用します。これは[trainコマンド](/guide/deep_learning/train_autopilot/)によって作成されます。

## Keras Categorical

このモデルタイプは`--type=categorical`で作成されます。

`KerasCategorical`パイロットは、ステアリングとスロットルの判断を離散角度に分割し、各選択に対して1つのニューロンが活性化するようカテゴリカルクロスエントロピーで学習します。これにより全ての選択に対する分布として信頼度が得られるのが興味深い点です。
`dk.utils.linear_bin` と `dk.utils.linear_unbin` を用いて連続値を離散値の範囲へ変換します。
そのため入力と出力には範囲があり、データに合うよう慎重に選定する必要があります。
デフォルトのレンジは標準構成で機能しますが、より高速に走る車ではスロットルの上限を上げる必要があるかもしれません。またステアリング角が大きい車ではより多くのビンを使いたくなるでしょう。

Donkeyが最初に作られた際、いくつかの改良を加えて使用されたのがこのモデルです。

#### 長所

* `makemovie`コマンドによって信頼度を分布として表示できるという利点があります。
* 非常に堅牢です。
* 場合によっては他のモデルよりもスロットル制御をうまく学習しています。
* Pi3のような計算資源の限られた環境でも良好に動作します。

#### 短所

* カテゴリ数やスロットル上限を任意に設定する必要がある点で、いくつか制約を受けます。

#### モデル概要

入力: 画像

ネットワーク: 5つの畳み込み層と2つの全結合層を経て出力されます

出力: 2つの全結合層、16と20のカテゴリカル出力

## Keras Linear

このモデルタイプは`--type=linear`で作成されます。

`KerasLinear`パイロットは1つのニューロンを用いて連続値を出力し
KerasのDenseレイヤを線形活性で使用します。ステアリング用とスロットル用に1つずつあります。
出力には範囲制限がありません。

#### 長所

* スムーズに操舵します。
* 非常に堅牢です。
* Pi3のような計算資源の限られた環境でも良好に動作します。
* ステアリングやスロットルに任意の制限がありません。

#### 短所

* スロットルの学習がうまくいかない場合があります。

#### モデル概要

入力: 画像

ネットワーク: 5つの畳み込み層と2つの全結合層を経て出力されます

出力: ステアリングとスロットルそれぞれに線形活性化されたスカラーを1つずつ出力する2つの全結合層

## Keras IMU

このモデルタイプは`--type=imu`で作成されます。

`KerasIMU`パイロットは`KerasLinear`モデルによく似ていますが、画像に加えて慣性計測データも使用して学習を行う点が異なります。
これによりステートレスなモデルでも車両の動きに関する追加情報を得ることができます。

より多くのデータをモデルに取り込む際の良い出発点となる例です。

#### 長所

* 非常に滑らかに操舵します。
* Pi3のような計算資源の限られた環境でも良好に動作します。
* ステアリングやスロットルに任意の制限がありません。
* モデルに追加の状態を与えるため、停止標識で停止するなどの挙動に役立つ可能性があります。

#### 短所

* IMUにノイズが多いと走行品質が悪化します。

#### モデル概要

入力: 画像、線加速度と角加速度のベクトル

ネットワーク: 5つの畳み込み層の後に2つの全結合層が続きます。ベクトルデータには3つの全結合層を通してからConv2D層の後で連結され、2つの制御用全結合層へ入ります。

出力: ステアリングとスロットルそれぞれに線形活性化されたスカラーを1つずつ出力する2つの全結合層

## Keras Latent

このモデルタイプは`--type=latent`で作成されます。

`KerasLatent`パイロットは、運転に加えて潜在ベクトルを学習させることを試みます。この潜在ベクトルはCNNのボトルネックとなり、入力画像の再現と運転指令の出力を同時に行います。この二重のタスクにより、走行シーンを抽象化し新しいコースへの適応がより容易になる可能性があります。

#### 長所

* 滑らかに操舵します。
* Pi3のような計算資源の限られた環境でも良好に動作します。
* ステアリングやスロットルに任意の制限がありません。
* モデルがシーンで重要と判断した箇所を画像出力で確認できます。

#### 短所

* 理論を実証するためにはさらなるテストが必要です。

#### モデル概要

入力: 画像

ネットワーク: 5つの畳み込み層から10×1×1ベクトルへのボトルネックを経て、6つのConv2dTranspose層で画像を再構成し、さらに3つの全結合層と運転制御へ接続します。

出力: ステアリングとスロットルそれぞれに線形活性化されたスカラーを1つずつ出力する2つの全結合層。さらに画像を出力します。

## Keras RNN

このモデルタイプは`--type=rnn`で作成されます。

`KerasRNN`パイロットは単一フレームではなく画像のシーケンスを使って運転を制御します。使用する画像数はmyconfig.pyの`SEQUENCE_LENGTH`値で決まります。

#### 長所

* 非常に滑らかに操舵します。
* より低い損失まで学習できます。

#### 短所

* Pi3のような計算資源の限られた環境では性能が劣ります。
* 学習に時間がかかります。

#### モデル概要

入力: 画像

ネットワーク: 時間分割された4つの畳み込み層、2つのLSTM層、3つの全結合層を経て運転制御を行います。

出力: ステアリングとスロットルの2つのスカラーを出力する1つの全結合層。

## Keras 3D

このモデルタイプは`--type=3d`で作成されます。

Keras3D_CNNパイロットは単一フレームではなく画像のシーケンスを使って運転を制御します。使用する画像数はmyconfig.pyのSEQUENCE_LENGTH値で決まり、他の多くのモデルが2D畳み込みを使うのに対し、本モデルは層を横断する3D畳み込みを使用します。

#### 長所

* 非常に滑らかに操舵します。
* より低い損失まで学習できます。

#### 短所

* Pi3のような計算資源の限られた環境では性能が劣ります。
* 学習に時間がかかります。

#### モデル概要

入力: 画像

ネットワーク: 4つの3D畳み込み層それぞれの後にプーリングを行い、続いて2つの全結合層を経て運転制御を行います。

出力: ステアリングとスロットルの2つのスカラーを出力する1つの全結合層。

## Keras Behavior

このモデルタイプは`--type=behavior`で作成されます。

KerasBehavioralパイロットは画像とベクターを入力として受け取ります。ベクターはコマンドをワンホット化したものです。例えば長さ2で左車線走行と右車線走行の2状態を表すことができます。学習中は望ましい挙動を示す際にベクターの該当要素を活性化させます。このベクターはmyconfig.pyの`BEHAVIOR_LIST`で定義され、`BEHAVIOR_LED_COLORS`も同じ長さに設定しておくと現在の状態表示に役立ちます。`TRAIN_BEHAVIORS`はTrueに設定する必要があります。

#### 長所

* 複数のタスクを実行できるモデルを作成可能です。

#### 短所

* 学習にはより多くの労力を要します。

#### モデル概要

入力: 画像、行動ベクター

ネットワーク: 5つの畳み込み層、2つの全結合層を経て運転制御を行います。

出力: Categorical kerasモデルと同様のカテゴリカルなステアリングとスロットルを出力します。

## Keras Localizer

このモデルタイプはコードを修正しない限り作成されません。

KerasLocalizerパイロットはKeras Linearモデルによく似ていますが、位置をカテゴリーとして出力する点が異なります。
このカテゴリーは任意ですが、0～9の範囲でトラックを区切った場合のみテストされています。走行データには位置を示すカテゴリラベルが付与されている必要があります。これにより走行戦略や周回数カウントなど、より高レベルのロジックにトラック位置を提供できます。

#### 長所

* スムーズに操舵します。
* Pi3のような計算資源の限られた環境でも良好に動作します。
* ステアリングやスロットルに任意の制限がありません。
* 位置情報を用いた高レベルロジックを提供できます。

#### 短所

* スロットルの学習がうまくいかない場合があります。

#### モデル概要

入力: 画像

ネットワーク: 5つの畳み込み層と2つの全結合層を経て出力されます

出力: ステアリングとスロットルそれぞれに線形活性化されたスカラーを1つずつ出力する2つの全結合層。さらに位置を示すカテゴリカル出力を持ちます。

