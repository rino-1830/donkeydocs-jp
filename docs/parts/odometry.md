# オドメトリ

オドメトリとは、ロータリーエンコーダーと呼ばれるセンサーでホイールの回転を計測し、車が移動した速度と距離を求める方法です。エンコーダーはモーターやメインドライブシャフト、あるいは各ホイールに取り付けられます。エンコーダーを使うとスロットルとのループを閉じることができるため、路面の傾斜や摩擦、旋回時の機械抵抗に左右されず実際の速度を確実に指示できます。要するに、エンコーダーを使えば速度をより細かく制御できます。

エンコーダーにはさまざまな形式があります

* **クアドラチャエンコーダー** は二つのセンサーで回転パルスを計測するため非常に精度が高く、前進と後退の区別もできます。磁気パルスを検出するホールセンサーや、外部の影響を受けないよう完全に覆われたスリットディスクに光を通す光学式センサーなどがあります。
* **モノエンコーダー** は一つのセンサーでパルスを数えるだけなので進行方向は分かりません。一般的にクアドラチャエンコーダーより小型で安価です。よくある例として、LED 送受信センサーとスリットディスクを組み合わせた光学式があり、出力シャフトが回転するとディスクを通る光が遮られ、その回数を数えます。安価で取り付けも簡単ですが回転方向は判別できません。

Donkey でエンコーダーを読み取る方法はいくつかあります。

**Arduino**:
推奨されるのは、Donkeycar に付属する Arduino スケッチを実行する **Arduino 互換マイコン** を利用する方法です。マイコンはパルス計測専用となるため高分解能のエンコーダーでも正確にカウントできます。パルスを取りこぼすと過小カウントになるので高分解能エンコーダーでは特に重要です。利用できる Arduino スケッチは次の二つです。

- [mono_encoder.ino](https://github.com/autorope/donkeycar/blob/main/arduino/mono_encoder/mono_encoder.ino) は 20 スロットのディスクを使うような単一チャンネルエンコーダーをサポートします。
- [quadrature_encoder.ino](https://github.com/autorope/donkeycar/blob/main/arduino/quadrature_encoder/quadrature_encoder.ino) は方向検出も可能な二チャンネルのクアドラチャエンコーダーをサポートします。

どちらのスケッチも単一エンコーダーまたは二つのエンコーダーを用いた差動駆動に対応しています。高分解能エンコーダーでは割り込みを利用したり、ポーリング方式でデバウンスを強化したりできます。どちらも Donkeycar から要求があったときに USB シリアル経由でカウント値を Raspberry Pi に送信するため、Pi の負荷を軽減できます。

**GPIO**:
低分解能のモノエンコーダーをモーターの出力シャフトや駆動シャフトに取り付けている場合、Raspberry Pi の GPIO ピンでパルスを数えるだけで十分かもしれません。GPIO ピンは 3.3V デバイスのみ対応しているので、エンコーダーの VCC を 3.3V で供給できれば、出力も 3.3V パルスになるため直接接続できます。


## 対応エンコーダー

対応しているロータリーエンコーダーの例:

* 光学式エンコーダーセンサーとディスク [Amazon でも多数販売](https://amzn.to/3s05QmG)
* クアドラチャエンコーダー。[大型で安価](https://amzn.to/3liBUjj) と [小型で高価](https://www.sparkfun.com/products/10932)

## ハードウェアのセットアップ

エンコーダーをどこに取り付けるかは使用する種類によって異なります。例えば [こちら](https://diyrobocars.com/2020/01/31/how-to-add-an-encoder-to-the-donkeycar-chassis/) はメインドライブシャフトにクアドラチャエンコーダーを取り付ける方法です。また [こちら](https://guitar.ucsd.edu/maeece148/index.php/Project_encoders) には二つのエンコーダーを用いた複雑な例があります。

ここでは標準の Donkeycar シャーシのメインドライブシャフトに安価で簡単な光学式エンコーダーを取り付ける最も手軽な方法を紹介します。シャーシが異なる場合でも大まかな手順は同じですが、センサーの設置場所を工夫してください。

まず、メインドライブシャフトを覆うプレートのネジを外します。後輪を少し後ろに傾けるとシャフトを取り外せます。

![drive shaft](../assets/driveshaft.jpg)

次に、センサーに付属する光学式エンコーダーディスクの穴をドリルやリューターで広げ、シャフトに通せるようにします。サーボ取り付け用などのゴムグロメットをシャフトにかぶせてディスクの穴に押し込みます。グロメットがない場合はシャフトにテープを巻き、ディスクがしっかり固定できる太さに調整します。位置が決まったら瞬間接着剤やホットグルーで固定してください。

![drive shaft](../assets/encoder1.jpg)

![drive shaft](../assets/encoder2.jpg)

ドライブシャフトを覆うプレートに小さな切り欠きを作り（写真では鉛筆で印を付けています）、そこにエンコーダーセンサーを取り付けます。ディスクがステアリングサーボ前の隙間で自由に回転できるようにしてください。

![drive plate](../assets/cuthere.jpg)

プレートを戻し、エンコーダーセンサーを固定するための穴を二つ開けます。ディスクがセンサーと擦れないよう、シャフト上で位置を調整します。

![drive plate](../assets/encoder_inplace.jpg)

三本のメス―メスジャンパー線を使い、センサーの GND、V+（5V または 3.3V と表示されている場合があります）およびデータピン（"Out" または "D0" と書かれている）を RPi の 5V、Ground、GPIO 13 に接続します。センサーに四つ目のピン "A0" がある場合は無視してください。
![wiring diagram](../assets/encoder_wiring.jpg)

注意: すでに GPIO 13 を RC 入出力などに使っている場合は、空いている別の GPIO ピンを使用できます。その際は `myconfig.py` の `ODOM_PIN` を下記のように変更してください。


## ソフトウェアセットアップ

`myconfig.py` でオドメトリを有効にします。

```
#
# ODOMETRY
#
HAVE_ODOM = False               # オドメーター／エンコーダーを搭載しているか
HAVE_ODOM_2 = False             # 差動駆動ロボットのように二つ目のオドメーターを搭載しているか
                                # この場合、1 つ目のエンコーダーは左輪、2 つ目は右輪となる
ENCODER_TYPE = 'GPIO'           # エンコーダーの種類: GPIO または arduino
                                # - 'GPIO' は単一チャンネルエンコーダーを RPi/Jetson の GPIO ヘッダーに直結
                                #   ボード番号に基づいて ODOM_PIN を設定する
                                # - 'arduino' はシリアル接続された任意のマイコンを指す
                                #   マイコンを接続するシリアルポートを ODOM_SERIAL に設定する
                                #   'arduino/encoder/encoder.ino' を参照すると継続送信と要求送信の両方を実装したスケッチがある
ENCODER_PPR = 20                # エンコーダー軸一回転あたりのパルス数
ENCODER_DEBOUNCE_NS = 0         # 次のパルスを取り込む前に待機するナノ秒
                                # ノイズの多いエンコーダーでは割り込みの誤発生を防ぐために利用
                                # 必要に応じてオシロスコープ等で測定するか試行して値を決める
FORWARD_ONLY = 1
FORWARD_REVERSE = 2
FORWARD_REVERSE_STOP = 3
TACHOMETER_MODE=FORWARD_REVERSE # FORWARD_ONLY, FORWARD_REVERSE, FORWARD_REVERSE_STOP のいずれか
                                # 二チャンネルのクアドラチャエンコーダーでは常に FORWARD_ONLY が正しい
                                # 単一チャンネルの場合は用途に応じて選択
                                # - FORWARD_ONLY は常にティックを加算し、車が常に前進していると仮定する
                                #   オープンなコースで後退や停止を考慮しないレース向き
                                # - FORWARD_REVERSE はスロットル値から前進か後退かを判断し、その通りにティックを増減する
                                #   スロットルが 0 のときは最後の非 0 スロットルに基づいて増減し、惰性走行を表す
                                #   例えばレースで減速のために惰性で進む状況に適している
                                # - FORWARD_REVERSE_STOP はスロットル値で前進・後退・停止を判断する
                                #   SLAM のように方向転換や後退を行う遅速ロボットに向く
MM_PER_TICK = WHEEL_RADIUS * 2 * 3.141592653589793 * 1000 / ENCODER_PPR  # 1 ティックあたりの走行距離(mm)。車を1m進め、得られたティック数を1000で割る
ODOM_SERIAL = '/dev/ttyACM0'    # ENCODER_TYPE='arduino' の場合のシリアルポート
ODOM_SERIAL_BAUDRATE = 115200   # シリアルポート型エンコーダーのボーレート
ODOM_PIN = 13                   # ENCODER_TYPE=GPIO の場合の入力ピン番号
ODOM_PIN_2 = 14                 # 差動駆動で 2 つ目を使う場合の GPIO ピン
ODOM_SMOOTHING = 1              # 速度計算に用いるオドメーター読取数
ODOM_DEBUG = False              # 実行中に速度と距離を表示するか
```

Arduino 互換マイコンでエンコーダーを読み取る場合は `myconfig.py` で `ENCODER_TYPE = 'arduino'` に設定します。マイコンには [arduino フォルダー](https://github.com/autorope/donkeycar/tree/main/arduino) のスケッチを Arduino IDE で書き込みます。書き込み後、シリアルコンソールで動作確認できます。これらのスケッチは r/p/c コマンドプロトコルを実装しており、要求に応じて値を返す方式と、指定した遅延で連続送信する方式の両方に対応しています。コマンドは 1 行ごと（末尾に '\n'）で送信します。

- `r` コマンド: 位置をゼロにリセット
- `p` コマンド: 位置を即座に送信
- `c` コマンド: 連続モードの開始／停止
    - 整数が続く場合は読み取り間隔(ミリ秒)として使用
    - 整数が続かない場合は連続モードを停止

単一エンコーダー構成では、ティック数とタイムスタンプをカンマ区切りのペアでシリアル／USB ポートに送信します:

```{ticks},{ticksMs}```

二つのエンコーダーを使う場合、二つ目の値はセミコロンで区切られます:

```{ticks},{ticksMs};{ticks},{ticksMs}```

エンコーダーの部品を実装している [`tachometer.py`](https://github.com/autorope/donkeycar/blob/main/donkeycar/parts/tachometer.py) には [`__main__`](https://github.com/autorope/donkeycar/blob/5e234c3101cc5f54935c240819e3840596c753a3/donkeycar/parts/tachometer.py#L597) 関数があり、直接実行できます。`donkey` Python 環境を有効にしてこのファイルを実行すると、配線確認や設定値の検討に役立ちます。利用可能な引数は次のコマンドで確認できます。

```
python donkeycar/parts/tachometer.py
```

## 姿勢推定とパスフォローのためのオドメーターと運動学
エンコーダーを使えば車両の速度だけでなく位置も推定できます。そのためには `myconfig.py` にホイール径やホイールベース、車軸長などを設定しておく必要があります。これにより、GPS の代わりにエンコーダーを使って [Path Follow](/guide/path_follow/path_follow) テンプレートを屋内で利用できます。

```
#
# 計測済みロボット特性
#
AXLE_LENGTH = 0.03     # 車軸の長さ(左右のホイール間) [m]
WHEEL_BASE = 0.1       # 前輪と後輪の間隔 [m]
WHEEL_RADIUS = 0.0315  # ホイール半径 [m]
MIN_SPEED = 0.1        # 最低速度[m/s]; これを下回ると停止
MAX_SPEED = 3.0        # 最高速度[m/s]; スロットル1.0時
MIN_THROTTLE = 0.1     # MIN_SPEED に対応するスロットル値(0〜1.0)
MAX_STEERING_ANGLE = 3.141592653589793 / 4  # 車型ロボットの最大操舵角[rad] (steering==-1 に相当)
```
