# 車をキャリブレーションする

車をキャリブレーションする目的は、車を常に同じように走らせることです。ステアリングサーボを使用している場合、Donkeyはハンドルを最大に左または右に切った際のPWM値を知る必要があります。ESCを使用している場合、全開スロットル、停止状態、全開リバーススロットルに対応するPWM値を把握する必要があります。キャリブレーション作業でこれらの値を求め、`myconfig.py` ファイルに保存することで、走行時にその値が利用されます。

**一部の駆動系ではキャリブレーションは不要です。** L298Nモーターコントローラなど（ESCではなく）を使用する駆動系であればキャリブレーションは必要ありません。これらの駆動系はPWMを使わず、キャリブレーション不要のデューティサイクルを使います。 [差動駆動](../parts/actuators.md#differential-drive-cars)の大半（名前が`DC_TWO_WHEEL`で始まるもの）はこのタイプです。スロットルにL298Nモーターコントローラを使い、ステアリングにサーボを使っている場合は、ステアリングだけをキャリブレーションする必要があります。

駆動系についてのより詳しい説明は [アクチュエータ](../parts/actuators.md) にあります。

## 車の設定を調整する方法

>キャリブレーションを行うには、PiにSSH接続する必要があります。

車のすべてのデフォルト設定は `config.py` にあります。これらの設定は、車ディレクトリにある `myconfig.py` スクリプトを編集することで上書きできます。このファイルは `donkey createcar --path ~/mycar` を実行したときに生成されました。以下のコマンドで車上のこのファイルを編集できます。

```bash
nano ~/mycar/myconfig.py
```

## ステアリングのキャリブレーション

> **暴走を防ぐため、車を地面から浮かせておいてください。**

1. 車の電源を入れます。
2. サーボの3ピンケーブルを確認し、PWM出力ピンに正しく接続されているか確かめます。
    - Donkey Hatを使用している場合、サーボの3ピンケーブルはHatに接続します。接続の詳細は[RC HatでESCとステアリングサーボを制御する](../parts/rc_hat.md/#controlling-esc-and-steering-servo-with-rc-hat)を参照してください。
    - PCA9685を使用する場合、サーボケーブルはPCA9685の3ピン入力チャンネルのどれかに接続します。詳しくは[サーボシールドをRaspberry Piに接続する](build_hardware.md/#step-4-connect-servo-shield-to-raspberry-pi)を参照してください。
3. `donkey calibrate ...` を実行し、どのピンからPWMを出力するか指定する引数を与えます。
    - `PWM_STEERING_THROTTLE` のようにピン指定子を用いる駆動系をキャリブレーションする場合は、`--pwm-pin` 引数で対象ピンを指定します。たとえば `RPI_GPIO.BOARD.33` や `PCA9685.1:40.13` です。[Donkey Hat](../parts/rc_hat.md/#controlling-esc-and-steering-servo-with-rc-hat) を使うなら `donkey calibrate --pwm-pin=PIGPIO.BCM.13` でステアリングをキャリブレーションします。ピンとピン指定子については [Pins](../parts/pins.md) を参照してください。
    - `I2C_SERVO` などのレガシーPCA9685駆動系を使用する場合、PCA9685のチャンネル（3ピンコネクタの番号）と接続しているI2Cバスを指定します。`donkey calibrate --channel <your_steering_channel> --bus=<your_i2c_bus>`
4. まず **タイヤが完全に左に切れる値** を探します。ステアリングをキャリブレーションする際には、**ちょうど最大までタイヤが回る値** を選びます。タイヤは端まで回るものの、**サーボが唸る音を出さない** ようにしてください。まずは `360` を試し、車輪が少し動くか確認します。動かなければ `400` や `300` を試してください。次に開始値から±10の範囲で値を入力し、車輪が完全に左へ切れるPWM設定を探します。このときもモーターが唸らないことを確認します。この値を覚えておきます。
5. 次に **タイヤが完全に右に切れる値** を探します。開始値から±10の範囲で値を入力して、車輪が完全に右へ切れるPWM値を見つけます。このときもモーターが唸らないことを確認します。この値を覚えておきます。

**車上の `myconfig.py` を編集し**, これらの値をそれぞれ `STEERING_LEFT_PWM` と `STEERING_RIGHT_PWM` に設定します。

- `STEERING_LEFT_PWM`  = 左に全開で切るときのPWM値
- `STEERING_RIGHT_PWM` = 右に全開で切るときのPWM値

## スロットルのキャリブレーション

1. ESCの3ピンケーブルを確認し、PWM出力ピンに正しく接続されているか確かめます。
    - Donkey Hatを使用している場合、ESCの3ピンケーブルはHatに接続します。接続の詳細は[RC HatでESCとステアリングサーボを制御する](../parts/rc_hat.md/#controlling-esc-and-steering-servo-with-rc-hat)を参照してください。
    - PCA9685を使用する場合、ESCの3ピンケーブルはPCA9685の3ピン入力チャンネルのどれかに接続します。詳しくは[サーボシールドをRaspberry Piに接続する](build_hardware.md/#step-4-connect-servo-shield-to-raspberry-pi)を参照してください。
2. `donkey calibrate ...` を実行し、どのピンからPWMを出力するか指定する引数を与えます。
    - `PWM_STEERING_THROTTLE` のようにピン指定子を用いる駆動系をキャリブレーションする場合は、`--pwm-pin` 引数で対象ピンを指定します。たとえば `RPI_GPIO.BOARD.33` や `PCA9685.1:40.13` です。[Donkey Hat](./parts/rc_hat/#controlling-esc-and-steering-servo-with-rc-hat) を使うなら `donkey calibrate --pwm-pin=PIGPIO.BCM.18` でスロットルをキャリブレーションします。ピンとピン指定子については [Pins](../parts/pins.md) を参照してください。
    - `I2C_SERVO` などのレガシーPCA9685駆動系を使用する場合、PCA9685のチャンネル（3ピンコネクタの番号）と接続しているI2Cバスを指定します。`donkey calibrate --channel <your_throttle_channel> --bus=<your_i2c_bus>`
3. PWM値の入力を求められたら `370` を入力します。
4. ESCがビープ音を鳴らし、キャリブレーションが完了したことを知らせます。
5. `400` を入力すると、車輪が前進し始めるはずです。もしそうでなければ
逆方向になっている可能性があるので、代わりに `330` を試してください。
6. 適切な最高速度になるまでさまざまな値を試し、そのPWM値を覚えておきます。

RCカーでのリバースは少し厄介で、後退するにはESCが「逆転パルス → ゼロパルス → 逆転パルス」の順で信号を受け取る必要があります。リバース用のPWM値をキャリブレーションするには...

1. 先ほどと同じ方法でPWM値をゼロスロットルの設定にします。
2. 逆転値を入力し、続けてゼロスロットルの値、さらにもう一度逆転値を入力します。
3. 逆転値から±10の範囲で値を入力し、適切な後退速度を見つけます。このリバースPWM値を覚えておきます。

次に `myconfig.py` を開き、以下のスロットルコントローラー関連の項目にあなたの車のPWM値を入力します。

* `THROTTLE_FORWARD_PWM` = 前進全開時のPWM値
* `THROTTLE_STOPPED_PWM` = スロットルゼロ時のPWM値
* `THROTTLE_REVERSE_PWM` = 後退全開時のPWM値

## キャリブレーションを微調整する

![細かなキャリブレーション](../assets/fine_calibration.gif)

車を大まかにキャリブレーションできたら、走行させて想定通りに走るか確認してみましょう。ここではキャリブレーションを微調整する方法を説明します。

まず最も重要なのは、**ステアリング入力がないときに車が完全に直進するか確認すること**です。

1. `python manage.py drive` を実行して車を起動します。
2. ブラウザで `<your_cars_hostname.local>:8887` にアクセスします。
3. キーボードの `i` キーを数回押して車を前進させます。できれば床が平らでグリッドがある場所で行うと、真っすぐ走っているか判断しやすくなります。斜めに走り出すのと円弧を描いて走るのを混同しないよう注意してください。斜めに走るだけなら、スタート時に車の向きが斜めだっただけかもしれません。円弧を描く場合は車がステアリングを切っているということです。
4. ステアリング操作なしで左に曲がる傾向がある場合、**myconfig.py** 内の `STEERING_LEFT_PWM` をニュートラルに近付けるよう調整します。たとえば `STEERING_LEFT_PWM` が460、`STEERING_RIGHT_PWM` が290なら、`STEERING_LEFT_PWM` を少し下げて458などにします。
5. ステアリング操作なしで右に曲がる場合は、**myconfig.py** 内の `STEERING_RIGHT_PWM` をニュートラルに近付けます。たとえば `STEERING_LEFT_PWM` が460、`STEERING_RIGHT_PWM` が290なら、`STEERING_RIGHT_PWM` を少し上げて292などにします。
6. この作業を何度か繰り返し、車が直進するようになるまで調整します。

次に、左に全開で曲がったときと右に全開で曲がったときの角度が同じになるように調整します（ぐるりと回ったときの円の直径が左右で同じになるようにします）。

> 注意：任意

1. `python manage.py drive` を実行して車を起動します。
2. ブラウザで `<your_cars_hostname.local>:8887` にアクセスします。
3. `j` キーを押して、ステアリングが右いっぱいになるまで回します。
4. `i` キーを数回押して車を前進させます。
5. 円を描いたときの直径を測定し、スプレッドシートに記録します。
6. 左右それぞれのステアリング値を変えながら同様の測定を繰り返します。
7. これらの値をグラフ化し、左右で同じように曲がるかどうかを確認します。

補正方法:

* 80%の舵角と100%の舵角で同じように曲がる場合、その方向のPWM値を80%の値に変更します。
* どちらかに曲がりやすい場合は、偏っていない側のPWM値を調整してバランスを取ります。

微調整後は、ステアリングのグラフが次のようになるはずです。

![キャリブレーショングラフ](../assets/calibration_graph.png)

車がまっすぐ走り、左右のターンが同じになるまで、何度か調整を繰り返す必要があるかもしれません。まずは直進できることを最優先してください。

### 次は [走行を始めましょう！](/guide/get_driving)
